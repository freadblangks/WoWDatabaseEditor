using System.Collections.Generic;
using WDE.Common.Managers;
using WDE.Common.Services;
using WDE.Module.Attributes;

namespace WDE.DatabaseEditors.Services;

internal interface IStandaloneTableEditorSettings
{
    bool HasWindowState(string table);
    bool GetWindowState(string table, out bool maximized, out int x, out int y, out int width, out int height);
    void UpdateWindowState(string table, bool maximized, int x, int y, int width, int height);
    void SetupWindow(string table, IAbstractWindowView window);
}

[AutoRegister]
[SingleInstance]
internal class StandaloneTableEditorSettings : IStandaloneTableEditorSettings
{
    private readonly IUserSettings userSettings;
    private Data settings;

    public StandaloneTableEditorSettings(IUserSettings userSettings)
    {
        this.userSettings = userSettings;
        settings = userSettings.Get<Data>(new Data())!;
    }

    private struct WindowState
    {
        public bool Maximized { get; set; }
        public int X { get; set; }
        public int Y { get; set; }
        public int Width { get; set; }
        public int Height { get; set; }
    }

    private class Data : ISettings
    {
        public Dictionary<string, WindowState> States { get; set; } = new Dictionary<string, WindowState>();
    }

    public bool HasWindowState(string table)
    {
        return settings.States.ContainsKey(table);
    }

    public bool GetWindowState(string table, out bool maximized, out int x, out int y, out int width, out int height)
    {
        if (settings.States.TryGetValue(table, out var state))
        {
            maximized = state.Maximized;
            x = state.X;
            y = state.Y;
            width = state.Width;
            height = state.Height;
            return true;
        }
        maximized = false;
        x = 0;
        y = 0;
        width = 0;
        height = 0;
        return false;
    }

    public void UpdateWindowState(string table, bool maximized, int x, int y, int width, int height)
    {
        settings.States[table] = new WindowState()
        {
            Maximized = maximized,
            X = x,
            Y = y,
            Width = width,
            Height = height
        };
        userSettings.Update(settings);
    }

    public void SetupWindow(string table, IAbstractWindowView window)
    {
        if (GetWindowState(table, out var maximized, out var x, out var y, out var width, out var height))
        {
            window.Reposition(x, y, maximized, width, height);
        }
        window.OnClosing += () =>
        {
            var position = window.Position;
            var size = window.Size;
            var maximized = window.IsMaximized;
            UpdateWindowState(table, maximized, position.x, position.y, size.x, size.y);
        };
    }
}